/*!CK:985555927!*//*1435060033,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["wVKrc"]); }

__d("MercuryParticipantTypes",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={USER:"user",THREAD:"thread",EVENT:"event",PAGE:"page",FRIEND:"friend",FB4C:"fb4c",NON_FRIEND:"non_friend"};},null);
__d("PageMessageEnumTag",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={FLAG:"flag",LOW_VALUE:"low_value"};},null);
__d("ChatImpressionLogger",["AsyncSignal","requireWeak","ChatConfig","ChatVisibility","Poller","PresencePrivacy","PresenceStatus","debounceAcrossTransitions","copyProperties"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){b.__markCompiled&&b.__markCompiled();var p=null;h(['AvailableList'],function(v){return p=v;});var q=null;function r(){if(!q)return '';return q.getCachedSortedList().toString();}function s(){if(!q||!p)return '';var v=[],w=q.getCachedSortedList();for(var x=0;x<w.length;x++)v[x]=p.get(w[x]);return v.toString();}function t(v){v.setURI('/ajax/chat/imps_logging.php').setData({list_availability:s(),sorted_list:r(),source:'periodical_imps'});}var u={init:function(v){q=v;var w=i.get('chat_impression_logging_periodical',0);if(w){var x=i.get('periodical_impression_logging_config.interval'),y=new k({interval:x,setupRequest:t,clearOnQuicklingEvents:false,dontStart:true});l.subscribe('privacy-user-presence-changed',n(function(){if(j.isOnline()){y.start();}else y.stop();}));}this.init=function(){};},logImpression:function(v,w,x){var y=i.get('chat_impression_logging_with_click'),z={list_availability:y?s():'',sorted_list:y?r():'',source:v,target:w,target_presence:m.get(w),viewport_width:document.body.clientWidth};new g('/ajax/chat/ct.php',o(z,x)).send();}};e.exports=u;},null);
__d("ChatWelcomeMessage",["ImmutableObject"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();'use strict';function h(){this.$ChatWelcomeMessage0={};}h.prototype.setWelcomeMessage=function(j,k,l){this.$ChatWelcomeMessage0[j]=new g({timestamp:Date.now(),thread_id:j,author:k,body:l});};h.prototype.getWelcomeMessage=function(j){return this.$ChatWelcomeMessage0[j];};var i=new h();e.exports=i;},null);
__d("MercuryIDs",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();var g={isValid:function(h){if(!h||typeof h!=='string')return false;return (/^\w{3,12}:/.test(h));},isValidThreadID:function(h){if(!g.isValid(h))return false;var i=g.tokenize(h);switch(i.type){case 'user':case 'group':case 'thread':case 'root':case 'pending':return true;default:return false;}},tokenize:function(h){if(!this.isValid(h))throw ("bad_id_format "+h);var i=h.indexOf(':');return {type:h.substr(0,i),value:h.substr(i+1)};},getUserIDFromParticipantID:function(h){if(!this.isValid(h))throw ("bad_id_format "+h);var i=g.tokenize(h),j=i.type,k=i.value;if(j!='fbid')return null;return k;},getParticipantIDFromUserID:function(h){if(isNaN(h))throw ("Not a user ID: "+h);return 'fbid:'+h;},getUserIDFromThreadID:function(h){if(!this.isCanonical(h))return null;return this.tokenize(h).value;},getThreadIDFromUserID:function(h){return 'user:'+h;},getThreadIDFromParticipantID:function(h){var i=this.getUserIDFromParticipantID(h);return i?this.getThreadIDFromUserID(i):null;},getParticipantIDFromFromThreadID:function(h){return this.getParticipantIDFromUserID(this.getUserIDFromThreadID(h)||'');},isCanonical:function(h){return this.isValid(h)&&this.tokenize(h).type==='user';},isGroupChat:function(h){return this.isValid(h)&&this.tokenize(h).type!=='user';}};e.exports=g;},null);
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();e.exports={isParticipantID:function(h){if(!g.isValid(h))throw ("bad_participant_id "+h);},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw ("bad_user_id "+h);},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw ("bad_email_id "+h);},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw ("bad_thread_id "+h);}};},null);
__d("MercuryAttachment",["MercuryAttachmentContentType","MercuryAttachmentType","MercuryAudioType"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();'use strict';var j={getAttachIconClass:function(k){switch(k){case g.PHOTO:return 'MercuryPhotoIcon';case g.VIDEO:return 'MercuryVideoIcon';case g.MUSIC:return 'MercuryMusicIcon';case g.VOICE:return 'MercuryVoiceIcon';case g.TEXT:return 'MercuryTextIcon';case g.MSWORD:return 'MercuryMSWordIcon';case g.MSXLS:return 'MercuryMSXLSIcon';case g.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(k){if(k.startsWith('image')){return 'MercuryPhotoIcon';}else if(k.startsWith('video')){return 'MercuryVideoIcon';}else if(k.startsWith('audio')){return 'MercuryMusicIcon';}else if(k.startsWith('text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(k){if(k.startsWith('image')){return g.PHOTO;}else if(k.startsWith('video')){return g.VIDEO;}else if(k.startsWith('audio')){return g.MUSIC;}else if(k.startsWith('text/plain')){return g.TEXT;}else return g.UNKNOWN;},convertRaw:function(k){var l=[];for(var m=0;m<k.length;m++){var n=k[m];if(n.attach_type===h.PHOTO){l.push(n);}else if(n.filename){var o=j.getAttachTypeByMime(n.filetype),p={};p.attach_type=h.FILE;p.name=n.filename;p.icon_type=o;p.url='';l.push(p);}}return l;},get:function(k){var l=[];if(k.attachments){l=k.attachments;}else if(k.raw_attachments)l=this.convertRaw(k.raw_attachments);if(!(k.attachments&&k.attachments.length>0)){if(k.sticker_id)return l.concat([{attach_type:h.STICKER}]);if(k.preview_attachments&&k.preview_attachments.length>0)return l.concat(k.preview_attachments);}return l;},resizeContain:function(k,l){var m=k.width/k.height,n=l.width/l.height;if(n<m){return {width:Math.ceil(Math.min(k.height*n,l.width)),height:Math.ceil(Math.min(k.height,l.height))};}else return {width:Math.ceil(Math.min(k.width,l.width)),height:Math.ceil(Math.min(k.width/n,l.height))};},isBubblePreferred:function(k){return !this.isStickerAttachment(k);},isPhotoAttachment:function(k){return !!(k.attach_type==h.PHOTO||k.attach_type==h.ANIMATED_IMAGE||(k.attach_type==h.FILE&&k.preview_url));},isVideoAttachment:function(k){return k.attach_type==h.VIDEO;},isShareAttachment:function(k){return k.attach_type==h.SHARE;},isFileAttachment:function(k){return k.attach_type==h.FILE;},isErrorAttachment:function(k){return k.attach_type==h.ERROR;},isStickerAttachment:function(k){return k.attach_type==h.STICKER;},isVoiceAttachment:function(k){if(!k.metadata)return false;return (k.metadata.type===i.AudioClip||k.metadata.type===i.VoiceMessageWithTranscript);}};e.exports=j;},null);
__d("MercurySendErrorLogger",["Banzai","BanzaiLogger"],function(a,b,c,d,e,f,g,h){b.__markCompiled&&b.__markCompiled();var i=h.create({retry:true}),j=g.isEnabled('mercury_send_error_logging'),k={log:function(l){if(!j)return;var m={message_id:l.message_id,timestamp_client:Date.now(),error_type:l.error_data.type,error_code:l.error_data.code,error_description:l.error_data.description,is_transient:l.error_data.is_transient};i.log('MercurySendErrorLoggerConfig',m);}};e.exports=k;},null);
__d("MercurySingletonMixin",["CurrentUser"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();var h={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(g.getID());},getForFBID:function(i){var j=this._getInstances();if(!j[i])j[i]=new this(i);return j[i];}};e.exports=h;},null);
__d("MercuryMessageClientState",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();var g={DO_NOT_SEND_TO_SERVER:'do_not_send_to_server',SEND_TO_SERVER:'send_to_server'};e.exports=g;},null);
__d("MercuryServerSendMessageQueueSimulatedError",["AsyncRequest","AsyncResponse","copyProperties"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();var j=9999,k={create:function(l){var m=new g(this.endpoint_uri).setData({message_batch:[l],client:this.client}),n=new h(m,{});i(n,{error:j,silentError:false,transientError:true,request:m});return n;}};e.exports=k;},null);
__d("MercuryServerSendMessageQueue",["BanzaiODS","LogHistory","MercuryLoggingHelper","MercuryServerRequestsConfig","MercuryServerDispatcher","MercuryServerSendMessageQueueSimulatedError"],function(a,b,c,d,e,f,g,h,i,j,k,l){b.__markCompiled&&b.__markCompiled();var m='/ajax/mercury/send_messages.php',n=h.getInstance('mercury_server_send_message_queue');function o(p,q,r,s){"use strict";this.sender_id=p;this.queue_id=q;this.$MercuryServerSendMessageQueue0=r.success_handler;this.$MercuryServerSendMessageQueue1=r.error_handler;this.$MercuryServerSendMessageQueue2=r.transport_error_handler;this.$MercuryServerSendMessageQueue3=r.timeout_handler;this.client=s;var t=null;if(j.msgrRegion)t={name:'X-MSGR-Region',value:j.msgrRegion};var u={};u[m]={request_user_id:this.sender_id,endpoint_id:this.queue_id,mode:k.IMMEDIATE,customHeader:t,handler:this.handleSuccess.bind(this),error_handler:this.handleError.bind(this),transport_error_handler:this.handleTransportError.bind(this),timeout:r.timeout,timeout_handler:this.handleTimeout.bind(this),connection_retries:r.connection_retries};k.registerEndpoints(u);this.pending_message=null;this.queue=[];}o.prototype.enqueue=function(p){"use strict";this.queue.push(p);this.$MercuryServerSendMessageQueue5();};o.prototype.$MercuryServerSendMessageQueue5=function(){"use strict";if(this.pending_message||!this.queue.length){if(this.pending_message)this.$MercuryServerSendMessageQueue6();return;}this.pending_message=this.queue.shift();k.trySend(m,{message_batch:[this.pending_message],client:this.client},null,this.sender_id,this.queue_id);};o.prototype.$MercuryServerSendMessageQueue7=function(){"use strict";while(this.queue.length)this.$MercuryServerSendMessageQueue8(this.queue.shift());};o.prototype.$MercuryServerSendMessageQueue8=function(p){"use strict";this.$MercuryServerSendMessageQueue1(l.create(p));n.error('mark_as_failed',{fbid:this.sender_id,queue_id:this.queue_id,message:i.obfuscateMessage(p)});};o.prototype.handleSuccess=function(p,q){"use strict";this.$MercuryServerSendMessageQueue0(p,q);this.pending_message=null;this.$MercuryServerSendMessageQueue5();};o.prototype.handleError=function(p){"use strict";this.$MercuryServerSendMessageQueue1(p);this.$MercuryServerSendMessageQueue7();this.pending_message=null;};o.prototype.handleTransportError=function(p){"use strict";this.$MercuryServerSendMessageQueue2(p);this.$MercuryServerSendMessageQueue7();this.pending_message=null;};o.prototype.handleTimeout=function(p){"use strict";this.$MercuryServerSendMessageQueue3(p);this.$MercuryServerSendMessageQueue7();this.pending_message=null;};o.prototype.$MercuryServerSendMessageQueue6=function(){"use strict";n.debug('maybe_send_next_pending_message',{fbid:this.sender_id,queue_id:this.queue_id,pending_message:i.obfuscateMessage(this.pending_message),queue:this.queue.map(function(q){return i.obfuscateMessage(q);})});var p='send_queue.delayed.queue_length.'+this.queue.length.toString();g.bumpEntityKey('chat.web',p);};e.exports=o;},null);
__d("MercuryServerSendMessageQueueRouter",["BanzaiODS","LogHistory","Map","MercuryServerSendMessageQueue","MercurySingletonMixin"],function(a,b,c,d,e,f,g,h,i,j,k){b.__markCompiled&&b.__markCompiled();var l=h.getInstance('mercury_server_send_message_queue_router'),m='chat.web.send_queue_router';g.setEntitySample(m,.1);function n(o){"use strict";this.fbid=o;this.queues=new i();}n.prototype.enqueue=function(o,p,q,r){"use strict";if(!this.queues.has(o)){this.queues.set(o,new j(this.fbid,o,p,q));l.debug('added queue',{fbid:this.fbid,queue_id:o});g.bumpEntityKey(m,'new_queue');}this.queues.get(o).enqueue(r);};Object.assign(n,k);e.exports=n;},null);
__d("FBID",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();'use strict';var g={isUser:function(h){return h<2.2e+09||(h>=1e+14&&h<=100099999989999)||(h>=8.9e+13&&h<=89999999999999)||(h>=6.000001e+13&&h<=60000019999999);}};e.exports=g;},null);
__d("PagesMessengerThreadUtils",["PageMessageEnumTag"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();var h={isFlagThread:function(i){if(!i)return false;return i.page_thread_info?i.page_thread_info.flagged:false;},isPageSpecficFilter:function(i){if(i===g.FLAG)return true;return false;}};e.exports=h;},null);
__d("MercuryPageServerRequests",["MercuryAPIArgsSource","MercuryAssert","MercuryServerRequests","PageMessageEnumTag","PagesMessengerThreadUtils","MercuryServerDispatcher"],function(a,b,c,d,e,f,g,h,i,j,k,l){b.__markCompiled&&b.__markCompiled();var m=g.MERCURY;for(var n in i)if(i.hasOwnProperty(n))p[n]=i[n];var o=i===null?null:i.prototype;p.prototype=Object.create(o);p.prototype.constructor=p;p.__superConstructor__=i;function p(q){"use strict";i.call(this,q);var r={'/pages/messaging/thread_tag/add/':{request_user_id:q,mode:l.BATCH_SUCCESSIVE,batch_function:this.$MercuryPageServerRequests0,handler:function(s,t){return this.__handleUpdate(s,t);}.bind(this)},'/pages/messaging/thread_tag/remove/':{request_user_id:q,mode:l.BATCH_SUCCESSIVE,batch_function:this.$MercuryPageServerRequests0,handler:function(s,t){return this.__handleUpdate(s,t);}.bind(this)},'/pages/messaging/thread_tag/list/':{request_user_id:q,mode:l.IMMEDIATE,handler:function(s,t){return this.__handleUpdate(s,t);}.bind(this)}};l.registerEndpoints(r);}p.prototype.$MercuryPageServerRequests0=function(q,r){"use strict";var s=q?q.tag_name:r.tag_name,t=q?q.thread_ids:[],u=r?r.thread_ids:[],v=t.concat(u),w={tag_name:s,thread_ids:v};return w;};p.prototype.addThreadFlag=function(q,r){"use strict";h.isThreadID(q);this.__threadIDMap.getFBIDFromClientID(q,function(s){var t={thread_ids:[s],tag_name:j.FLAG};this.__sendRequest('/pages/messaging/thread_tag/add/',t);}.bind(this));};p.prototype.fetchThreadlistInfo=function(q,r,s,t,u){"use strict";if(k.isPageSpecficFilter(t)){u=u||m;var v={folder:s,tag_name:t,offset:q,limit:r};this.__sendRequest('/pages/messaging/thread_tag/list/',v);return;}o.fetchThreadlistInfo.call(this,q,r,s,t,u);};p.prototype.removeThreadFlag=function(q,r){"use strict";h.isThreadID(q);this.__threadIDMap.getFBIDFromClientID(q,function(s){var t={thread_ids:[s],tag_name:j.FLAG};this.__sendRequest('/pages/messaging/thread_tag/remove/',t);}.bind(this));};p.prototype.toString=function(){"use strict";return 'MercuryPageServerRequests';};e.exports=p;},null);
__d("MercuryServerRequestSingletonMixin",["CurrentUser","FBID"],function(a,b,c,d,e,f,g,h){b.__markCompiled&&b.__markCompiled();var i={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(g.getID());},getForFBID:function(j){var k=this._getInstances();if(!k[j])if(h.isUser(j)){k[j]=new this(j);}else{var l;d(['MercuryPageServerRequests'],function(m){l=new m(j);});k[j]=l;}return k[j];}};e.exports=i;},null);
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();var h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;},null);
__d("MercuryServerSendMessageQueueOptions",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();function g(h,i,j,k,l,m){"use strict";this.success_handler=h;this.error_handler=i;this.transport_error_handler=j;this.timeout_handler=k;this.timeout=l;this.connection_retries=m;}e.exports=g;},null);
__d("MercuryServerRequests",["Arbiter","AsyncResponse","ChannelConstants","CurrentUser","LogHistory","MercuryActionStatus","MercuryActionType","MercuryAPIArgsSource","MercuryAssert","MercuryDispatcher","MercuryThreadIDMap","MercuryErrorType","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercuryMessageClientState","MercuryPayloadSource","MercurySendErrorLogger","MercuryServerRequestsConfig","MercuryServerSendMessageQueueRouter","MercuryServerRequestSingletonMixin","MercurySourceType","MercuryThreadlistConstants","MercuryMessageIDs","MessagingConfig","MessagingTag","MercuryServerDispatcher","MercuryServerSendMessageQueueOptions","copyProperties","createObjectFrom","errorCode","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la){b.__markCompiled&&b.__markCompiled();'use strict';var ma=k.getInstance('mercury_server'),na=n.MERCURY;function oa(ab){return ab.thread_fbid||ab.thread_id||ab.client_thread_id;}function pa(ab){return ab.getError()?'_'+ab.getError():'';}function qa(ab,bb){var cb=ia({},ab),db;if(bb.threads){if(!cb.threads)cb.threads={};for(db in bb.threads)cb.threads[db]=Object.keys(ja((cb.threads[db]||[]).concat(bb.threads[db])));}if(bb.messages){if(!cb.messages)cb.messages={};for(db in bb.messages){if(!cb.messages[db])cb.messages[db]={};for(var eb in bb.messages[db])if(cb.messages[db][eb]){cb.messages[db][eb]=va(cb.messages[db][eb],bb.messages[db][eb]);}else cb.messages[db][eb]=bb.messages[db][eb];}}cb.client=ab.client||bb.client;return cb;}function ra(ab,bb){var cb=ia(ja(ab.folders,true),ja(bb.folders,true)),db=ab.client||bb.client;return {folders:Object.keys(cb),client:db};}function sa(ab,bb){for(var cb in bb)if(ab[cb]&&typeof ab[cb]==='object'){ab[cb]=va(ab[cb],bb[cb]);}else if(bb[cb]&&typeof bb[cb]==='object'){var db={};ia(db,bb[cb]);ab[cb]=db;}return ab;}function ta(ab,bb){var cb=Object.assign({},ab.ids,bb.ids),db=ab.client||bb.client;return {ids:cb,client:db};}function ua(ab,bb){return bb;}function va(ab,bb){var cb=ab.offset<bb.offset?ab.offset:bb.offset,db=ab.offset+ab.limit,eb=bb.offset+bb.limit,fb=(db>eb)?db:eb,gb=fb-cb,hb=ab.timestamp>bb.timestamp?ab.timestamp:bb.timestamp;return {offset:cb,limit:gb,timestamp:hb};}function wa(ab,bb){var cb=ab.client||bb.client,db={ids:{},client:cb};ia(db.ids,ab.ids);ia(db.ids,bb.ids);return db;}function xa(ab,bb){var cb={},db,eb=ab.client||bb.client;delete ab.client;delete bb.client;for(db in ab)ia(cb,ja(ab[db],db));for(db in bb)ia(cb,ja(bb[db],db));var fb={client:eb};for(var gb in cb){db=cb[gb];if(!fb[db])fb[db]=[];fb[db].push(gb);}return fb;}function ya(ab,bb){var cb=ab.client||bb.client,db=ja(ab.ids,true),eb=ja(bb.ids,true),fb=ia(db,eb);return {ids:Object.keys(fb),client:cb};}function za(ab){this._fbid=ab;this._lastActionTimestamp=0;this._fetchingThreads={};this._sentMessagesTimestamp={};this.__threadIDMap=q.getForFBID(this._fbid);this._dispatcher=p.getForFBID(this._fbid);this._sendMessageQueueOptions=new ha(function(bb,cb){return this.__handleUpdate(bb,cb);}.bind(this),function(bb){return this._handleSendMessageError(bb);}.bind(this),function(bb){return this._handleSendMessageTransportError(bb);}.bind(this),function(bb){return this._handleSendMessageTimeout(bb);}.bind(this),y.sendMessageTimeout,ea.SEND_CONNECTION_RETRIES);this._registerEndpoints();}Object.assign(za.prototype,{fetchThreadlistInfo:function(ab,bb,cb,db,eb){cb=cb||fa.INBOX;eb=eb||na;var fb=db?ga.IMMEDIATE:null,gb={client:eb};gb[cb]={offset:ab,limit:bb,filter:db};this.__sendRequest('/ajax/mercury/threadlist_info.php',gb,fb);},fetchPinnedThreads:function(){this.__sendRequest('/mercury/pinned_threads/',{});},fetchUnseenThreadIDs:function(ab,bb){bb=bb||na;this.fetchThreadlistInfo(ca.RECENT_THREAD_OFFSET,ca.JEWEL_THREAD_COUNT,ab,null,bb);},fetchUnreadThreadIDs:function(ab,bb){bb=bb||na;this.__sendRequest('/ajax/mercury/unread_threads.php',{folders:[ab],client:bb});},fetchMissedMessages:function(ab,bb){bb=bb||na;var cb={last_action_timestamp:this._lastActionTimestamp,folders:ab,client:bb};cb.last_action_timestamp=this._lastActionTimestamp;this.__sendRequest('/ajax/mercury/thread_sync.php',cb);},fetchThreadData:function(ab,bb){bb=bb||na;o.allThreadID(ab);var cb={threads:{},client:bb},db=[],eb=[];ab.forEach(function(gb){if(this._fetchingThreads[gb])return;this._fetchingThreads[gb]=true;var hb=this.__threadIDMap.getFBIDFromClientIDNow(gb),ib=t.tokenize(gb);if(ib.type=='user'){db.push(ib.value);cb.threads.user_ids=db;}else if(ib.type=='thread'){if(hb){eb.push(hb);}else eb.push(ib.value);cb.threads.thread_fbids=eb;}else if(ib.type=='root'){if(hb){eb.push(hb);cb.threads.thread_fbids=eb;}}else if(ib.type!='pending')throw new Error('Unknown thread type',ib);}.bind(this));this._dispatcher.inform("fetch-thread-data",cb);for(var fb in cb.threads){this.__sendRequest('/ajax/mercury/thread_info.php',cb);break;}},ensureThreadIsFetched:function(ab,bb){bb=bb||na;if(!this.__threadIDMap.getClientIDFromFBIDNow(ab)&&!this._fetchingThreads[ab]){this._fetchingThreads[ab]=true;this.__sendRequest('/ajax/mercury/thread_info.php',{threads:{thread_fbids:[ab]},client:bb});}},fetchThreadMessages:function(ab,bb,cb,db,eb,fb){o.isThreadID(ab);fb=fb||na;var gb,hb,ib=t.tokenize(ab),jb=this.__threadIDMap.getFBIDFromClientIDNow(ab),kb=false;if(jb){gb=jb;hb=(ib.type=='user')?'user_ids':'thread_fbids';}else{gb=ib.value;switch(ib.type){case 'user':hb='user_ids';kb=true;break;case 'thread':hb='thread_fbids';break;}}var lb={messages:{},threads:{},client:fb};if(hb){lb.messages[hb]={};lb.messages[hb][gb]={offset:bb,timestamp:db,limit:cb};if(kb)lb.threads[hb]=[gb];this.__sendRequest('/ajax/mercury/thread_info.php',lb,eb);}else this.__threadIDMap.getFBIDFromClientID(ab,function(mb){lb.messages.thread_fbids={};lb.messages.thread_fbids[mb]={offset:bb,timestamp:db,limit:cb};this.__sendRequest('/ajax/mercury/thread_info.php',lb,eb);}.bind(this));},handleThreadInfoError:function(ab){var bb=ab.getRequest().getData(),cb=[];if(bb.messages){for(var db in bb.messages.thread_fbids)cb.push(this._createServerErrorLogMessage(this.__threadIDMap.getClientIDFromFBIDNow(db)));for(var eb in bb.messages.user_ids)cb.push(this._createServerErrorLogMessage('user:'+eb));for(var fb in bb.messages.group_ids)cb.push(this._createServerErrorLogMessage('group:'+fb));}if(cb.length)this._dispatcher.handleUpdate({actions:cb,from_client:true,payload_source:w.CLIENT_CHANNEL_MESSAGE});if(bb.threads&&(bb.threads.user_ids||bb.threads.group_ids||bb.threads.thread_ids)){var gb=5,hb=true;if(!bb.retry_count){bb.retry_count=0;if(bb.messages)delete bb.messages;}else if(bb.retry_count>=gb){hb=false;(bb.threads.thread_ids||[]).forEach(function(jb){if(jb in this._fetchingThreads)delete this._fetchingThreads[jb];}.bind(this));}if(hb){var ib=Math.pow(2,bb.retry_count)*1000;la(function(){ma.log('retry_thread',bb);this.__sendRequest('/ajax/mercury/thread_info.php',bb);}.bind(this),ib);bb.retry_count++;}}},markFolderAsRead:function(ab){this.__sendRequest('/ajax/mercury/mark_folder_as_read.php',{folder:ab});var bb=[{action_type:s.MARK_ALL_READ,action_id:null,folder:ab}];this._dispatcher.handleUpdate({global_actions:bb,from_client:true,payload_source:w.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(ab,bb,cb){o.isThreadID(ab);this.__threadIDMap.getFBIDFromClientID(ab,function(db){var eb={ids:{},source:cb};eb.ids[db]=bb;this.__sendRequest('/ajax/mercury/change_read_status.php',eb);}.bind(this));},changeThreadArchivedStatus:function(ab,bb,cb){o.isThreadID(ab);this.__threadIDMap.getFBIDFromClientID(ab,function(db){var eb={ids:{},source:cb};eb.ids[db]=bb;this.__sendRequest('/ajax/mercury/change_archived_status.php',eb);}.bind(this));},changeThreadFolder:function(ab,bb){o.isThreadID(ab);this.__threadIDMap.getFBIDFromClientID(ab,function(cb){var db={};db[bb]=[cb];this.__sendRequest('/ajax/mercury/move_thread.php',db);}.bind(this));},changeMutingOnThread:function(ab,bb){o.isThreadID(ab);this.__threadIDMap.getFBIDFromClientID(ab,function(cb){this.__sendRequest('/ajax/mercury/change_mute_thread.php',{thread_fbid:cb,mute_settings:bb,payload_source:na});}.bind(this));},markThreadSpam:function(ab,bb){o.isThreadID(ab);this.__threadIDMap.getFBIDFromClientID(ab,function(cb){this.__sendRequest('/ajax/mercury/mark_spam.php',{id:cb,source:bb});}.bind(this));},markMessagesSpam:function(ab,bb){da.getServerIDs(bb||[],function(cb){this.__sendRequest('/ajax/mercury/mark_spam_messages.php',{message_ids:cb});}.bind(this));},unmarkThreadSpam:function(ab,bb){o.isThreadID(ab);this.__threadIDMap.getFBIDFromClientID(ab,function(cb){this.__sendRequest('/ajax/mercury/unmark_spam.php',{id:cb,source:bb});}.bind(this));},deleteThread:function(ab,bb){o.isThreadID(ab);this.__threadIDMap.getFBIDFromClientID(ab,function(cb){var db={ids:[cb],source:bb};this.__sendRequest('/ajax/mercury/delete_thread.php',db);}.bind(this));},unpinThread:function(ab){o.isThreadID(ab);this.__threadIDMap.getFBIDFromClientID(ab,function(bb){this.__sendRequest('/mercury/unpin_thread/',{id:bb});}.bind(this));},deleteMessages:function(ab,bb){da.getServerIDs(bb||[],function(cb){this.__sendRequest('/ajax/mercury/delete_messages.php',{message_ids:cb});}.bind(this));},sendDeliveryReceipts:function(ab){da.getServerIDs(ab||[],function(bb){this.__sendRequest('/ajax/mercury/delivery_receipts.php',{message_ids:bb});}.bind(this));},sendNewMessage:function(ab,bb){bb=bb||na;if(!ab.client_state||ab.client_state==v.SEND_TO_SERVER){var cb=t.tokenize(ab.thread_id),db=cb.type,eb=ia({},ab);if((db=='root'&&cb.value==eb.message_id)||(db=='user')){eb.client_thread_id=eb.thread_id;eb.thread_id=null;this._sendNewMessageToServer(eb,bb);}else this.__threadIDMap.getFBIDFromClientID(eb.thread_id,function(fb){cb=t.tokenize(eb.thread_id);if(cb.type=='user'){eb.other_user_fbid=cb.values;}else eb.thread_fbid=fb;eb.thread_id=null;this._sendNewMessageToServer(eb);}.bind(this));}},_sendNewMessageToServer:function(ab,bb){g.inform(i.ATTEMPT_RECONNECT);bb=bb||na;this._sentMessagesTimestamp[ab.message_id]=Date.now();z.getForFBID(this._fbid).enqueue(oa(ab),this._sendMessageQueueOptions,bb,ab);},requestMessageConfirmation:function(ab,bb){bb=bb||na;var cb={},db={};for(var eb in ab){var fb=this.__threadIDMap.getFBIDFromClientIDNow(eb);if(fb){cb[fb]=ab[eb];}else{var gb=ab[eb];for(var hb=0;hb<gb.length;hb++)db[gb[hb]]=eb;}}var ib=Object.keys(cb),jb=Object.keys(db);if(ib.length||jb.length)this.__sendRequest('/ajax/mercury/confirm_messages.php',{thread_message_map:cb,local_messages:db,client:bb});},handleMessageConfirmError:function(ab){var bb=ab.getRequest().getData().thread_message_map,cb=ab.getRequest().getData().local_messages;if(!bb&&!cb)return;var db=[];for(var eb in bb){var fb=bb[eb];fb.forEach(function(ib){db.push({action_type:m.SEND_MESSAGE,client_message_id:ib,message_id:ib,client_thread_id:null,thread_fbid:eb,status:l.UNABLE_TO_CONFIRM});});}for(var gb in cb){var hb=cb[gb];db.push({action_type:m.SEND_MESSAGE,client_message_id:gb,message_id:gb,client_thread_id:hb,thread_fbid:null,status:l.UNABLE_TO_CONFIRM});}if(db.length)this._dispatcher.handleUpdate({actions:db,payload_source:w.CLIENT_HANDLE_ERROR});},markSeen:function(){var ab=this._lastActionTimestamp;this.__sendRequest('/ajax/mercury/mark_seen.php',{seen_timestamp:ab});},handleRoger:function(ab){this._dispatcher.handleRoger(ab);},handleUpdateWaitForThread:function(ab,bb,cb){this._dispatcher.handleUpdateWaitForThread(ab,bb,cb);},handleUpdate:function(ab){this._dispatcher.handleUpdate(ab);},_handleSendMessageErrorCommon:function(ab,bb,cb,db){ma.debug('handle_send_message_error_common',{reliability_error_status:cb,request_error_status:bb});var eb=ab.getData(),fb=eb.message_batch,gb=fb.map(function(ib){var jb={action_type:m.SEND_MESSAGE,thread_fbid:ib.thread_fbid,client_message_id:ib.message_id,message_id:ib.message_id,client_thread_id:ib.client_thread_id,status:bb,error_data:db};return jb;});gb.forEach(function(ib){if(ib.action_type===m.SEND_MESSAGE&&ib.status===l.ERROR)x.log(ib);},this);var hb={actions:gb,payload_source:w.CLIENT_HANDLE_ERROR};this._dispatcher.handleUpdate(hb);},handleSendMessageError:function(ab){var bb=ab.getPayload(),cb=null,db=null;if(bb&&bb.error_payload){cb=l.UNCONFIRMED;db='send_error';}else{cb=l.ERROR;db='request_error'+pa(ab);}var eb=ab.error;if(eb===1404102)h.verboseErrorHandler(ab);var fb=/<.*>/.test(ab.getErrorDescription())?ab.getErrorSummary():ab.getErrorDescription();this._handleSendMessageErrorCommon(ab.getRequest(),cb,db,{type:r.SERVER,code:ab.getError(),description:fb,is_transient:ab.isTransient()});},handleSendMessageTransportError:function(ab){this._handleSendMessageErrorCommon(ab.getRequest(),l.ERROR,'transport_error'+pa(ab),{type:r.TRANSPORT,code:ab.getError(),is_transient:true});},handleSendMessageTimeout:function(ab){this._handleSendMessageErrorCommon(ab,l.ERROR,'transport_timeout',{type:r.TIMEOUT,is_transient:true});},getLastActionTimestamp:function(){return this._lastActionTimestamp;},updateLastActionTimestamp:function(ab){if(ab)this._lastActionTimestamp=Math.max(this._lastActionTimestamp,ab);},markThreadFetched:function(ab){delete this._fetchingThreads[ab];},_createServerErrorLogMessage:function(ab){return {action_type:m.LOG_MESSAGE,thread_id:ab,message_id:ab,timestamp:Date.now(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:ba.UNKNOWN,log_message_type:u.SERVER_ERROR,log_message_data:{}};},_getForAsyncRequest:function(ab){var bb=ab.getData(),cb=bb.request_user_id?bb.request_user_id:j.getID();return za.getForFBID(cb);},__handleUpdate:function(ab,bb){this._getForAsyncRequest(bb).handleUpdate(ab);},_handleThreadInfoError:function(ab){var bb=this._getForAsyncRequest(ab.getRequest());bb.handleThreadInfoError(ab);},_handleSendMessageError:function(ab){var bb=this._getForAsyncRequest(ab.getRequest());bb.handleSendMessageError(ab);},_handleSendMessageTransportError:function(ab){var bb=this._getForAsyncRequest(ab.getRequest());bb.handleSendMessageTransportError(ab);},_handleSendMessageTimeout:function(ab){var bb=this._getForAsyncRequest(ab);bb.handleSendMessageTimeout(ab);},_handleMessageConfirmError:function(ab){var bb=this._getForAsyncRequest(ab.getRequest());bb.handleMessageConfirmError(ab);},_registerEndpoints:function(){var ab=null;if(y.msgrRegion)ab={name:'X-MSGR-Region',value:y.msgrRegion};var bb={'/ajax/mercury/thread_sync.php':{request_user_id:this._fbid,mode:ga.IDEMPOTENT,customHeader:ab,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/thread_info.php':{request_user_id:this._fbid,mode:ga.BATCH_DEFERRED_MULTI,customHeader:ab,batch_function:qa,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this),error_handler:function(cb){return this._handleThreadInfoError(cb);}.bind(this)},'/ajax/mercury/mark_folder_as_read.php':{request_user_id:this._fbid,mode:ga.IMMEDIATE,customHeader:ab,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/change_read_status.php':{request_user_id:this._fbid,mode:ga.BATCH_SUCCESSIVE,customHeader:ab,batch_function:ta,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/mark_seen.php':{request_user_id:this._fbid,mode:ga.BATCH_SUCCESSIVE,customHeader:ab,batch_function:ua,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/confirm_messages.php':{request_user_id:this._fbid,mode:ga.IMMEDIATE,customHeader:ab,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this),error_handler:function(cb){return this._handleMessageConfirmError(cb);}.bind(this)},'/ajax/mercury/threadlist_info.php':{request_user_id:this._fbid,mode:ga.BATCH_SUCCESSIVE_UNIQUE,customHeader:ab,batch_function:sa,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/mark_spam.php':{request_user_id:this._fbid,mode:ga.IMMEDIATE,customHeader:ab,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/mark_spam_messages.php':{request_user_id:this._fbid,mode:ga.IMMEDIATE,customHeader:ab,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/unmark_spam.php':{request_user_id:this._fbid,mode:ga.IMMEDIATE,customHeader:ab,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/unread_threads.php':{request_user_id:this._fbid,mode:ga.BATCH_SUCCESSIVE_UNIQUE,customHeader:ab,batch_function:ra,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/chat/settings.php':{request_user_id:this._fbid,mode:ga.IMMEDIATE,customHeader:ab},'/ajax/mercury/change_archived_status.php':{request_user_id:this._fbid,mode:ga.BATCH_SUCCESSIVE,customHeader:ab,batch_function:wa,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/delete_thread.php':{request_user_id:this._fbid,mode:ga.BATCH_SUCCESSIVE,customHeader:ab,batch_function:ya,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/delete_messages.php':{request_user_id:this._fbid,mode:ga.IMMEDIATE,customHeader:ab,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/delivery_receipts.php':{request_user_id:this._fbid,mode:ga.IMMEDIATE,customHeader:ab,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/move_thread.php':{request_user_id:this._fbid,mode:ga.BATCH_SUCCESSIVE,customHeader:ab,batch_function:xa,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/ajax/mercury/change_mute_thread.php':{request_user_id:this._fbid,mode:ga.IMMEDIATE,customHeader:ab,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/mercury/pinned_threads/':{request_user_id:this._fbid,mode:ga.BATCH_SUCCESSIVE_UNIQUE,customHeader:ab,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)},'/mercury/unpin_thread/':{request_user_id:this._fbid,mode:ga.IMMEDIATE,customHeader:ab,handler:function(cb,db){return this.__handleUpdate(cb,db);}.bind(this)}};ga.registerEndpoints(bb);},__sendRequest:function(ab,bb,cb){ga.trySend(ab,bb,cb,this._fbid);}});Object.assign(za,aa);e.exports=za;},null);
__d("MercuryThreadIDMap",["KeyedCallbackManager","MercuryAssert","MercuryIDs","MercurySingletonMixin"],function(a,b,c,d,e,f,g,h,i,j){b.__markCompiled&&b.__markCompiled();'use strict';function k(l){this.$MercuryThreadIDMap0=l;this.$MercuryThreadIDMap1=new g();this.$MercuryThreadIDMap2=new g();this.$MercuryThreadIDMap3=new g();}k.prototype.setServerToClientID=function(l,m){this.$MercuryThreadIDMap1.setResource(l,m);};k.prototype.getClientIDFromServerIDNow=function(l){return this.$MercuryThreadIDMap1.getResource(l);};k.prototype.setFBIDToClientID=function(l,m){this.$MercuryThreadIDMap2.setResource(l,m);this.$MercuryThreadIDMap3.setResource(m,l);};k.prototype.getClientIDFromFBIDNow=function(l){return this.$MercuryThreadIDMap2.getResource(l);};k.prototype.getClientIDFromFBID=function(l,m){this.$MercuryThreadIDMap2.executeOrEnqueue(l,m);d(['MercuryServerRequests'],function(n){n.getForFBID(this.$MercuryThreadIDMap0).ensureThreadIsFetched(l);}.bind(this));};k.prototype.setClientIDToFBID=function(l,m){this.$MercuryThreadIDMap3.setResource(l,m);this.$MercuryThreadIDMap2.setResource(m,l);};k.prototype.getFBIDFromClientIDNow=function(l){return this.$MercuryThreadIDMap3.getResource(l);};k.prototype.getFBIDFromClientID=function(l,m){h.isThreadID(l);var n=this.$MercuryThreadIDMap3.executeOrEnqueue(l,m);d(['MercuryServerRequests'],function(o){var p=this.$MercuryThreadIDMap3.getUnavailableResources(n),q=i.tokenize(l);if(p.length&&q.type!='root')o.getForFBID(this.$MercuryThreadIDMap0).fetchThreadData(p);}.bind(this));};k.prototype.hasClientIDForFBID=function(l){return !!this.getClientIDFromFBIDNow(l);};k.prototype.convertThreadIDIfAvailable=function(l){var m=this.getClientIDFromFBIDNow(l);if(m===(void 0)){return l;}else return m;};k.prototype.canLinkExternally=function(l){h.isThreadID(l);var m=i.tokenize(l);return (m.type=='user')||!!this.getFBIDFromClientIDNow(l);};Object.assign(k,j);e.exports=k;},null);
__d("MercuryThreadInformer",["ArbiterMixin","LogHistory","MercuryAssert","MercuryLoggingHelper","MercurySingletonMixin","copyProperties","mapObject","mixin"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){b.__markCompiled&&b.__markCompiled();'use strict';var o=h.getInstance('mercury_informer'),p=n(g);for(var q in p)if(p.hasOwnProperty(q))s[q]=p[q];var r=p===null?null:p.prototype;s.prototype=Object.create(r);s.prototype.constructor=s;s.__superConstructor__=p;function s(u){this.$MercuryThreadInformer0=u;this.$MercuryThreadInformer1={};this.$MercuryThreadInformer2={};this.$MercuryThreadInformer3={};this.$MercuryThreadInformer4=false;this.$MercuryThreadInformer5=false;this.$MercuryThreadInformer6=false;this.$MercuryThreadInformer7={};this.$MercuryThreadInformer8={};this.$MercuryThreadInformer9={};this.$MercuryThreadInformera=0;}s.prototype.updatedThread=function(u){this.$MercuryThreadInformer2[u]=true;this.$MercuryThreadInformerb();};s.prototype.deletedThread=function(u){this.$MercuryThreadInformer1[u]=true;this.$MercuryThreadInformerb();};s.prototype.updatedThreadlist=function(){this.$MercuryThreadInformer4=true;this.$MercuryThreadInformerb();};s.prototype.updatedUnseenState=function(){this.$MercuryThreadInformer5=true;this.$MercuryThreadInformerb();};s.prototype.updatedUnreadState=function(){this.$MercuryThreadInformer6=true;this.$MercuryThreadInformerb();};s.prototype.changedThreadReadState=function(u,v,w){if(!this.$MercuryThreadInformer3[u]||this.$MercuryThreadInformer3[u].timestamp<w)this.$MercuryThreadInformer3[u]={mark_as_read:v,timestamp:w};this.$MercuryThreadInformerb();};s.prototype.receivedMessage=function(u){i.isThreadID(u.thread_id);var v=u.thread_id;if(!this.$MercuryThreadInformer7[v])this.$MercuryThreadInformer7[v]=[];this.$MercuryThreadInformer7[v].push(u);this.updatedThread(v);};s.prototype.reorderedMessages=function(u,v){this.$MercuryThreadInformer8[u]={source:v};this.$MercuryThreadInformerb();};s.prototype.updatedMessage=function(u,v,w){if(!this.$MercuryThreadInformer9[u])this.$MercuryThreadInformer9[u]={};this.$MercuryThreadInformer9[u][v]={source:w};this.updatedThread(u);};s.prototype.synchronizeInforms=function(u){this.$MercuryThreadInformera++;try{u();}catch(v){throw v;}finally{this.$MercuryThreadInformera--;this.$MercuryThreadInformerb();}};s.prototype.listen=function(u,v){return this.subscribe('threads-updated',function(w,x){if(x[u])v(u);});};s.prototype.$MercuryThreadInformerb=function(){if(!this.$MercuryThreadInformera){var u=this.$MercuryThreadInformer1,v=this.$MercuryThreadInformer2,w=this.$MercuryThreadInformer3,x=this.$MercuryThreadInformer4,y=this.$MercuryThreadInformer5,z=this.$MercuryThreadInformer6,aa=this.$MercuryThreadInformer7,ba=this.$MercuryThreadInformer8,ca=this.$MercuryThreadInformer9;this.$MercuryThreadInformer1={};this.$MercuryThreadInformer2={};this.$MercuryThreadInformer3={};this.$MercuryThreadInformer4=false;this.$MercuryThreadInformer5=false;this.$MercuryThreadInformer6=false;this.$MercuryThreadInformer7={};this.$MercuryThreadInformer8={};this.$MercuryThreadInformer9={};var da=Object.keys(v);if(da.length||x)this.inform('threadlist-updated',da);if(da.length)this.$MercuryThreadInformerc('threads-updated',v);for(var ea in w){this.$MercuryThreadInformerc('thread-read-changed',w);break;}for(ea in u){this.$MercuryThreadInformerc('threads-deleted',u);break;}if(y)this.$MercuryThreadInformerc('unseen-updated',null);if(z)this.$MercuryThreadInformerc('unread-updated',null);for(ea in aa){this.$MercuryThreadInformerc('messages-received',aa);break;}for(ea in ba){this.$MercuryThreadInformerc('messages-reordered',ba);break;}for(ea in ca){this.$MercuryThreadInformerc('messages-updated',ca);break;}}};s.prototype.$MercuryThreadInformerc=function(u,v){t(u,v);this.inform(u,v);};function t(u,v){var w=v;if(u=='messages-received')w=m(w,function(x){return x.map(function(y){return j.obfuscateMessage(y);});});o.debug(u,w);}l(s,k);e.exports=s;},null);
__d("MercuryDispatcher",["ArbiterMixin","LogHistory","MercuryIDs","MercuryActionStatus","MercuryActionType","MercuryAPIArgsSource","MercuryLoggingHelper","MercuryPayloadSource","MercurySendErrorLogger","MercurySingletonMixin","MercuryThreadIDMap","MercuryThreadInformer","isEmpty","mixin"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){b.__markCompiled&&b.__markCompiled();'use strict';var u=h.getInstance('mercury_dispatcher'),v=t(g);for(var w in v)if(v.hasOwnProperty(w))y[w]=v[w];var x=v===null?null:v.prototype;y.prototype=Object.create(x);y.prototype.constructor=y;y.__superConstructor__=v;function y(z){this.$MercuryDispatcher0=z;this.$MercuryDispatcher1=[];this.$MercuryDispatcher2=q.getForFBID(this.$MercuryDispatcher0);this.$MercuryDispatcher3={};}y.prototype.handleUpdate=function(z){var aa={actions:[],threads:[]};if(z){if(z.actions)aa.actions=z.actions.map(function(da){return m.obfuscateMessage(da);});if(z.threads)aa.threads=z.threads.map(function(da){return m.obfuscateThread(da);});}var ba=Object.assign({},z,aa),ca=z.payload_source;if(ca!==n.CLIENT_CHANGE_READ_STATUS&&ca!==n.CLIENT_MARK_THREAD_SEEN)u.debug('update:'+ca,{payload:ba,from_client:z.from_client});if(!s(z))r.getForFBID(this.$MercuryDispatcher0).synchronizeInforms(function(){if(!z.from_client){this.$MercuryDispatcher4(z);this.inform('payload-preprocessed',z);}this.inform('update-thread-ids',this.$MercuryDispatcher3);this.$MercuryDispatcher3={};this.inform('update-participants',z);this.inform('update-threads',z);this.inform('update-unread',z);this.inform('update-threadlist',z);this.inform('update-pinned-threads',z);this.inform('update-messages',z);this.inform('update-unseen',z);this.inform('update-typing-state',z);this.inform('update-roger',z.roger);this.inform('model-update-completed',null);this.$MercuryDispatcher5();}.bind(this));};y.prototype.handleUpdateWaitForThread=function(z,aa,ba){ba=ba||l.MERCURY;var ca=this.$MercuryDispatcher2.getClientIDFromFBIDNow(aa);if(ca){this.handleUpdate(z);return;}this.$MercuryDispatcher2.getClientIDFromFBID(aa,function(){return this.$MercuryDispatcher1.push(z);}.bind(this));d(['MercuryServerRequests'],function(da){da.getForFBID(this.$MercuryDispatcher0).ensureThreadIsFetched(aa);}.bind(this));};y.prototype.$MercuryDispatcher5=function(){if(this.$MercuryDispatcher1&&this.$MercuryDispatcher1.length){var z=this.$MercuryDispatcher1[0];this.$MercuryDispatcher1=this.$MercuryDispatcher1.slice(1);this.handleUpdate(z);}};y.prototype.$MercuryDispatcher4=function(z){(z.threads||[]).forEach(function(ja){this.$MercuryDispatcher6(ja);var ka=this.$MercuryDispatcher2.getFBIDFromClientIDNow(ja.thread_id);d(['MercuryServerRequests'],function(la){var ma=la.getForFBID(this.$MercuryDispatcher0);ma.markThreadFetched(ja.thread_id);ma.markThreadFetched(ka);ma.updateLastActionTimestamp(ja.timestamp);}.bind(this));}.bind(this));(z.ordered_threadlists||[]).forEach(function(ja){var ka=ja.thread_fbids||[];ka=ka.concat(ja.other_user_fbids||[]);ja.thread_ids=ka.map(function(la){return this.$MercuryDispatcher2.getClientIDFromFBIDNow(la);}.bind(this));}.bind(this));if(z.pinned_threads&&z.pinned_threads.thread_fbids)z.pinned_threads.thread_fbids=z.pinned_threads.thread_fbids.map(function(ja){return this.$MercuryDispatcher2.getClientIDFromFBIDNow(ja);}.bind(this));z.actions=z.actions||[];z.actions.forEach(function(ja){if(ja.action_type===k.SEND_MESSAGE&&ja.status===j.ERROR)o.log(ja);var ka=ja.thread_fbid;if(ja.other_user_fbid)ka=ja.other_user_fbid;if(ja.status&&ja.status!=j.SUCCESS&&!ka){ja.thread_id=ja.client_thread_id;return;}if(ja.action_type==k.SEND_MESSAGE&&ja.client_thread_id&&ka){var la=ka.toString(),ma=ja.client_thread_id;this.$MercuryDispatcher2.setClientIDToFBID(ma,la);this.$MercuryDispatcher3[la]=ma;}var na=ja.thread_id;if(ka){ja.thread_id=this.$MercuryDispatcher2.hasClientIDForFBID(ka)?this.$MercuryDispatcher2.getClientIDFromFBIDNow(ka):null;}else if(ja.client_thread_id)ja.thread_id=ja.client_thread_id;if(!ja.thread_id)ja.server_thread_id=na;if(!z.payload_source||!z.payload_source.startsWith('server'))d(['MercuryServerRequests'],function(oa){oa.getForFBID(this.$MercuryDispatcher0).updateLastActionTimestamp(ja.timestamp);}.bind(this));}.bind(this));if(z.end_of_history){var aa=[];for(var ba=0;ba<z.end_of_history.length;ba++){var ca=z.end_of_history[ba];if(ca.type=='user'){aa.push('user:'+ca.fbid);}else if(ca.type=='thread'&&this.$MercuryDispatcher2.hasClientIDForFBID(ca.fbid))aa.push(this.$MercuryDispatcher2.getClientIDFromFBIDNow(ca.fbid));}z.end_of_history=aa;}if(z.roger){var da={};for(var ea in z.roger){var fa=this.$MercuryDispatcher2.getClientIDFromFBIDNow(ea);if(fa){var ga=z.roger[ea];da[fa]={};for(var ha in ga)if(ga.hasOwnProperty(ha)){var ia=i.getParticipantIDFromUserID(ha);da[fa][ia]=ga[ha];}}}z.roger=da;}};y.prototype.$MercuryDispatcher6=function(z){var aa=z.thread_fbid;if(z.canonical_fbid)aa=z.canonical_fbid;var ba=this.$MercuryDispatcher2.getClientIDFromFBIDNow(aa);if(!ba){if(z.canonical_fbid){ba='user:'+z.canonical_fbid;}else if(z.root_message_threading_id)ba='root:'+z.root_message_threading_id;ba=ba||'thread:'+aa;if(aa)aa=aa.toString();this.$MercuryDispatcher2.setClientIDToFBID(ba,aa);this.$MercuryDispatcher3[aa]=ba;if(z.thread_id){this.$MercuryDispatcher2.setServerToClientID(z.thread_id,ba);this.$MercuryDispatcher3[z.thread_id]=ba;}}z.thread_id=ba;};y.prototype.handleRoger=function(z){var aa=z.thread_fbid?this.$MercuryDispatcher2.getClientIDFromFBIDNow(z.thread_fbid):i.getThreadIDFromUserID(z.reader);if(aa){var ba=i.getParticipantIDFromUserID(z.reader),ca={};ca[aa]={};ca[aa][ba]=z.time;this.inform('update-roger',ca);}};Object.assign(y,p);e.exports=y;},null);
__d("MercuryThreadInfo",["CurrentUser","MercuryIDs","MercuryThreadMode"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();'use strict';var j={canReply:function(l){return !!(l.is_subscribed&&l.mode!=i.OBJECT_ORIGINATED&&!l.has_email_participant&&!l.read_only&&(l.recipients_loadable||l.recipients_loadable===(void 0)));},getMuteSetting:function(l){return (l.mute_settings&&l.mute_settings[k(g.getID())]);},isEmptyLocalThread:function(l){return (h.tokenize(l.thread_id).type==='root'&&!l.timestamp);},isMuted:function(l){return j.getMuteSetting(l)!==(void 0);},isMessageBlocked:function(l){return l.message_blocked;}};function k(l){return l+'@facebook.com';}e.exports=j;},null);
__d("MercuryThreads",["EventEmitter","ImmutableObject","KeyedCallbackManager","LogHistory","Map","MercuryActionType","MercuryAssert","MercuryAttachment","MercuryDispatcher","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercuryLoggingHelper","MercuryPayloadSource","MercurySingletonMixin","MercuryThreadInfo","MercuryThreadMode","MessagingTag","MercuryServerRequests","Set","MercuryThreadInformer","fbt","setImmediate"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca){b.__markCompiled&&b.__markCompiled();'use strict';var da=new g(),ea=j.getInstance('mercury_threads');function fa(ga){this.$MercuryThreads0=ga;this.$MercuryThreads1=y.getForFBID(this.$MercuryThreads0);this.$MercuryThreads2=aa.getForFBID(this.$MercuryThreads0);this.$MercuryThreads3=q.getParticipantIDFromUserID(this.$MercuryThreads0);this.$MercuryThreads4=o.getForFBID(this.$MercuryThreads0);this.$MercuryThreads5=false;this.$MercuryThreads6=new i();this.$MercuryThreads7=new z();this.$MercuryThreads8=false;this.$MercuryThreads9=new z();this.$MercuryThreadsa=new z();this.$MercuryThreadsb();}fa.prototype.getThreadMetaNow=function(ga){m.isThreadID(ga);return this.$MercuryThreads6.getResource(ga);};fa.prototype.getOrFetch=function(ga){var ha=this.getThreadMetaNow(ga);if(!ha&&!this.$MercuryThreadsa.has(ga))this.$MercuryThreads9.add(ga);if(this.$MercuryThreads9.size>0&&!this.$MercuryThreads8)this.$MercuryThreadsc();return ha;};fa.prototype.$MercuryThreadsc=function(){if(this.$MercuryThreads8)return;this.$MercuryThreads8=true;ca(function(){this.$MercuryThreads8=false;this.$MercuryThreads9.forEach(function(ga){return this.$MercuryThreadsa.add(ga);}.bind(this));this.getMultiThreadMeta(Array.from(this.$MercuryThreads9),function(ga){for(var ha in ga)ga.hasOwnProperty(ha)&&this.$MercuryThreadsa["delete"](ha);}.bind(this));this.$MercuryThreads9.clear();}.bind(this));};fa.prototype.getThreadMeta=function(ga,ha,ia){return this.getMultiThreadMeta([ga],function(ja){return ha(ja[ga]);},ia);};fa.prototype.getMultiThreadMeta=function(ga,ha,ia){m.allThreadID(ga);var ja=this.$MercuryThreads6.executeOrEnqueue(ga,ha),ka=this.$MercuryThreads6.getUnavailableResources(ja);if(ka.length){var la=[];for(var ma=0;ma<ka.length;ma++){var na=ka[ma],oa=q.tokenize(na),pa=oa.type,qa=oa.value;if(pa=='user'){var ra=q.getParticipantIDFromUserID(qa);this.createNewLocalThread(na,ra===this.$MercuryThreads3?[this.$MercuryThreads3]:[this.$MercuryThreads3,ra]);}else la.push(na);}if(la.length)this.$MercuryThreads1.fetchThreadData(la,ia);}return ja;};fa.addListener=function(ga,ha){return da.addListener(ga,ha);};fa.prototype.unsubscribe=function(ga){this.$MercuryThreads6.unsubscribe(ga);};fa.prototype.getCanonicalThreadToParticipant=function(ga,ha,ia,ja){var ka=q.getThreadIDFromParticipantID(ga),la=this.$MercuryThreads6.getResource(ka);if(typeof la=='undefined'){la=this.createNewLocalThread(ka,this.$MercuryThreads3===ga?[this.$MercuryThreads3]:[this.$MercuryThreads3,ga],ha);!ja&&this.$MercuryThreads1.fetchThreadData([ka],ia);}return la;};fa.prototype.createNewLocalThread=function(ga,ha,ia){var ja=this.$MercuryThreads6.getResource(ga);if(!ja){var ka=q.tokenize(ga),la=ka.type,ma=ka.value;ja=new h({thread_id:ga,last_action_id:null,participants:Array.from(ha),name:null,snippet:'',snippet_has_attachment:false,snippet_sender:null,unread_count:ia?ia:0,message_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,canonical_fbid:la==='user'?ma:null,is_canonical_user:la=='user',is_canonical:this.$MercuryThreadsd(ha),is_subscribed:true,root_message_threading_id:null,folder:x.INBOX,is_archived:false,mode:w.TITAN_ORIGINATED});this.$MercuryThreads6.setResource(ga,ja);}return ja;};fa.prototype.isEmptyLocalThread=function(ga){var ha=this.$MercuryThreads6.getResource(ga);if(!ha)return false;return v.isEmptyLocalThread(ha);};fa.prototype.isNewEmptyLocalThread=function(ga){if(!this.isEmptyLocalThread(ga))return false;var ha=this.$MercuryThreads6.getResource(ga);return !!ha.participants&&ha.participants.length===0;};fa.prototype.$MercuryThreadse=function(ga,ha){if(!ga||!ga.length)return;var ia=new k(),ja=new k(),ka=new k(),la=[];for(var ma=0;ma<ga.length;ma++){var na=ga[ma];if(na.is_forward)continue;var oa=na.action_type;if(oa==l.LOG_MESSAGE&&na.log_message_type==r.SERVER_ERROR)continue;var pa=!!(na.sync_id||na.action_id),qa=na.thread_id;m.isThreadID(qa);var ra=this.$MercuryThreads6.getResource(qa);if(!ra&&!pa&&oa==l.USER_GENERATED_MESSAGE){ra=this.$MercuryThreadsf(na);this.$MercuryThreads6.setResource(qa,ra);}if(!ra)continue;if(oa==l.LOG_MESSAGE||oa==l.USER_GENERATED_MESSAGE)pa=!ha;if(ra.server_timestamp&&na.timestamp<=ra.server_timestamp&&pa)continue;if(!ka.has(qa))ka.set(qa,Object.assign({},ra));this.$MercuryThreadsg(ka.get(qa),na,ha);if(oa==l.USER_GENERATED_MESSAGE)ia.set(qa,na);if(oa==l.USER_GENERATED_MESSAGE||oa==l.LOG_MESSAGE||oa==l.SEND_MESSAGE)if(na&&na.timestamp&&(!ja.has(qa)||na.timestamp>ja.get(qa).timestamp))ja.set(qa,na);}ka.forEach(function(sa,ta){var ua=ja.get(ta),va=ia.get(ta);if(va){this.$MercuryThreadsh(sa,va);}else if(ua&&(ua.log_message_type==r.PHONE_CALL||ua.log_message_type==r.VIDEO_CALL)){var wa=Object.assign({},ua,{body:ua.log_message_body});this.$MercuryThreadsh(sa,wa);}var xa=sa.timestamp;if(ua){if(ua.timestamp>xa)Object.assign(sa,{timestamp_absolute:ua.timestamp_absolute,timestamp_relative:ua.timestamp_relative,timestamp:ua.timestamp});var ya=sa.server_timestamp;if(!ha&&ua.timestamp>ya)sa.server_timestamp=ua.timestamp;}var za=new h(sa);this.$MercuryThreads6.setResource(ta,za);la.push(s.obfuscateThread(za));}.bind(this),this);la.length&&this.$MercuryThreads5&&ea.debug('threads_updated',{threads:la});};fa.prototype.$MercuryThreadsg=function(ga,ha,ia){var ja=ha.action_type;if(ja==l.USER_GENERATED_MESSAGE||ja==l.LOG_MESSAGE){ha.is_unread&&ga.unread_count++;ga.message_count++;ga.is_archived=false;}switch(ja){case l.DELETE_THREAD:ga.message_count=0;this.$MercuryThreadsi(ha.thread_id);break;case l.USER_GENERATED_MESSAGE:if(ga.last_read_timestamp>=ha.timestamp)this.$MercuryThreadsj(ga,ha,true);this.$MercuryThreadsk(ga,ha.author);break;case l.SEND_MESSAGE:var ka=ha.log_message_type;if(ka==r.THREAD_IMAGE){ga.image_src=ha.log_message_data.image?ha.log_message_data.image.preview_url:null;this.$MercuryThreadsl(ha.thread_id);}ga.snippet_attachments=ha.attachments;break;case l.LOG_MESSAGE:var ka=ha.log_message_type;if(ka==r.SUBSCRIBE){this.$MercuryThreadsm(ga,ha.log_message_data.added_participants);this.$MercuryThreadsl(ha.thread_id);}else if(ka==r.UNSUBSCRIBE){this.$MercuryThreadsn(ga,ha.log_message_data.removed_participants);this.$MercuryThreadsl(ha.thread_id);}else if(ka==r.THREAD_IMAGE){if(!ia)ga.image_src=ha.log_message_data.image?ha.log_message_data.image.preview_url:null;}else if(ka==r.THREAD_NAME){if(ga.name!==ha.log_message_data.name)this.$MercuryThreadsl(ha.thread_id);ga.name=ha.log_message_data.name;}break;case l.CHANGE_READ_STATUS:var la=this.$MercuryThreadsj(ga,ha,ha.mark_as_read);if(la&&ha.timestamp)ga.last_read_timestamp=ha.timestamp;if(la&&ia)this.$MercuryThreads1.changeThreadReadStatus(ga.thread_id,ha.mark_as_read,ha.source);break;case l.CHANGE_ARCHIVED_STATUS:if(ga.is_archived!=ha.archived){ga.is_archived=ha.archived;this.$MercuryThreadsl(ha.thread_id);}break;case l.CHANGE_FOLDER:if(ga.folder!=ha.new_folder){ga.folder=ha.new_folder;this.$MercuryThreadsl(ha.thread_id);}break;case l.DELETE_MESSAGES:if(ia){ga.snippet='...';ga.snippet_has_attachment=false;ga.snippet_attachments=null;ga.snippet_sender=null;ga.is_forwarded_snippet=false;this.$MercuryThreadsl(ha.thread_id);}else if(ha.message_ids)ga.message_count=ga.message_count-ha.message_ids.length;break;case l.UPDATE_BLOCK_STATUS:ga.message_blocked=ha.is_message_blocked;this.$MercuryThreadsl(ha.thread_id);break;case l.CHANGE_MUTE_SETTINGS:if(ha.mute_settings!==(void 0)){var ma=this.$MercuryThreads0+'@facebook.com';if(ga.mute_settings){if(ha.mute_settings){var na={};na[ma]=ha.mute_settings;ga.mute_settings=Object.assign({},ga.mute_settings,na);}else{ga.mute_settings=Object.assign({},ga.mute_settings);delete ga.mute_settings[ma];}this.$MercuryThreadsl(ga.thread_id);}}break;case l.ADD_PARTICIPANTS:this.$MercuryThreadsm(ga,ha.participants);this.$MercuryThreadsl(ga.thread_id);break;case l.CHANGE_FLAG:this.$MercuryThreadso(ga,ha.mark_as_flag);this.$MercuryThreadsl(ga.thread_id);break;case l.MOVE_PENDING_TO_INBOX:this.$MercuryThreadsp(ga);this.$MercuryThreadsl(ga.thread_id);break;}};fa.prototype.$MercuryThreadsf=function(ga){var ha=q.tokenize(ga.thread_id),ia=ha.type,ja=ha.value,ka=this.$MercuryThreadsd(ga.specific_to_list);return new h({thread_id:ga.thread_id,last_action_id:null,participants:ga.specific_to_list,name:null,snippet:ga.body,snippet_has_attachment:false,snippet_attachments:[],snippet_sender:ga.author,unread_count:0,message_count:0,image_src:null,timestamp_absolute:ga.timestamp_absolute,timestamp_relative:ga.timestamp_relative,timestamp:ga.timestamp,canonical_fbid:ia==='user'?ja:null,is_canonical_user:ia==='user',is_canonical:ka,is_subscribed:true,root_message_threading_id:ga.message_id,folder:x.INBOX,is_archived:false,mode:w.TITAN_ORIGINATED});};fa.prototype.$MercuryThreadsj=function(ga,ha,ia){if(ha.timestamp)this.$MercuryThreadsq(ga.thread_id,ia,ha.timestamp);if(!ga||!ga.thread_id)return false;if(!ga.timestamp){this.$MercuryThreads7.add(ga.thread_id);return false;}var ja=!ga.unread_count;if(ia==ja)return false;ga.unread_count=ia?0:1;this.$MercuryThreadsl(ga.thread_id);return true;};fa.prototype.$MercuryThreadsr=function(ga){var ha=this.$MercuryThreads6.getAllResources();for(var ia in ha)if(ha.hasOwnProperty(ia)){var ja=ha[ia];if(ja.folder==ga){this.$MercuryThreads6.setResource(ia,h.setProperty(ja,'unread_count',0));this.$MercuryThreadsl(ia);}}};fa.prototype.$MercuryThreadsm=function(ga,ha){var ia=new z(ga.participants);ga.participants=Array.from(ga.participants);ha.forEach(function(ja){if(!ia.has(ja)){ga.participants.push(ja);if(ja===this.$MercuryThreads3)ga.is_subscribed=true;}}.bind(this));};fa.prototype.$MercuryThreadsn=function(ga,ha){var ia=new z(ha);ga.participants=ga.participants.filter(function(ja){return !ia.has(ja);});if(ia.has(this.$MercuryThreads3))ga.is_subscribed=false;this.$MercuryThreads1.fetchThreadData([ga.thread_id]);};fa.prototype.$MercuryThreadsk=function(ga,ha){if(ga.participants[0]!=ha){ga.participants=ga.participants.filter(function(ia){return ia!=ha;});ga.participants.unshift(ha);}};fa.prototype.$MercuryThreadsh=function(ga,ha){var ia=ha.body,ja=ha.subject,ka='';if(ja){ja=ja.toLowerCase();if(ia.slice(0,ja.length).toLowerCase()==ja){ka=ia;}else if(ia){ka=ja+' \u00B7 '+ia;}else ka=ja;}else ka=ia;if(ha.is_filtered_content)ka=ba._("This message has been temporarily removed because the sender's account requires verification, or it was identified as abusive.");ga.snippet=ka;ga.snippet_has_attachment=ha.has_attachment;if(ha.raw_attachments&&ha.raw_attachments.length>0){var la=n.convertRaw(ha.raw_attachments);ga.snippet_attachments=la;}else ga.snippet_attachments=ha.attachments;ga.is_forwarded_snippet=!!ha.forward_count;ga.snippet_sender=ha.author;};fa.prototype.$MercuryThreadso=function(ga,ha){ga.page_thread_info=Object.assign({},ga.page_thread_info,{flagged:ha});};fa.prototype.$MercuryThreadsp=function(ga){if(ga.folder!==x.PENDING)return;ga.folder=x.INBOX;};fa.prototype.$MercuryThreadsd=function(ga){return ga.filter(function(ha){return ha!=this.$MercuryThreads3;}.bind(this)).length<=1;};fa.prototype.$MercuryThreadsb=function(){this.$MercuryThreads4.subscribe('update-threads',function(ga,ha){var ia=(ha.actions||[]).filter(function(ja){return ja.thread_id;});if(ha.threads&&ha.payload_source==t.SERVER_FETCH_THREAD_INFO)ha.threads.forEach(function(ja){var ka=ja.thread_id;if(this.$MercuryThreads7.has(ka)){this.$MercuryThreads7["delete"](ka);if(ja.unread_count)this.$MercuryThreads1.changeThreadReadStatus(ja.thread_id,true);}}.bind(this));this.$MercuryThreadss(ha.threads);this.$MercuryThreadse(ia,ha.from_client);ha.threads&&ha.threads.forEach(function(ja){this.$MercuryThreadsl(ja.thread_id);}.bind(this));if(ha.global_actions)ha.global_actions.forEach(function(ja){if(ja.action_type==p.MARK_ALL_READ)this.$MercuryThreadsr(ja.folder);}.bind(this));if(this.$MercuryThreads5){this.$MercuryThreads5=false;da.emit('change');}}.bind(this));};fa.prototype.$MercuryThreadss=function(ga){if(!ga||!ga.length)return;var ha={},ia=[];ga.forEach(function(ja){var ka=new h(ja);ha[ja.thread_id]=ka;ia.push(s.obfuscateThread(ka));});ia.length&&ea.debug('threads_added',{threads:ia});this.$MercuryThreads6.addResourcesAndExecute(ha);};fa.prototype.$MercuryThreadsl=function(ga){this.$MercuryThreads5=true;this.$MercuryThreads2.updatedThread(ga);};fa.prototype.$MercuryThreadsi=function(ga){this.$MercuryThreads5=true;this.$MercuryThreads2.deletedThread(ga);};fa.prototype.$MercuryThreadsq=function(ga,ha,ia){this.$MercuryThreads5=true;this.$MercuryThreads2.changedThreadReadState(ga,ha,ia);};Object.assign(fa,u);e.exports=fa;},null);
__d("WebMessengerPermalinkConstants",["MercuryConfig","URI"],function(a,b,c,d,e,f,g,h){b.__markCompiled&&b.__markCompiled();var i={ARCHIVED_PATH:'/messages/archived',BASE_PATH:'/messages',PENDING_PATH:'/messages/pending',OTHER_PATH:'/messages/other',SPAM_PATH:'/messages/spam',COMPOSE_POSTFIX_PATH:'/new',SEARCH_POSTFIX_PATH:'/search',TID_POSTFIX_PARTIAL_PATH:'/conversation-',overriddenVanities:g.CoreGraphEnabled?'(archived|other|pending|spam|new|search|conversation-.*)':'(archived|other|spam|new|search|conversation-.*)',getURIPathForThreadID:function(j,k){return (k||i.BASE_PATH)+i.TID_POSTFIX_PARTIAL_PATH+h.encodeComponent(h.encodeComponent(j));},getThreadIDFromURI:function(j){var k=j.getPath().match(i.BASE_PATH+'(/[^/]*)*'+i.TID_POSTFIX_PARTIAL_PATH+'([^/]+)');if(k){var l=h.decodeComponent(h.decodeComponent(k[2]));return l;}},getURIPathForIDOrVanity:function(j,k){if(j.match('^'+i.overriddenVanities+'$'))j='.'+j;return (k||i.BASE_PATH)+'/'+j;},getUserIDOrVanity:function(j){var k=j.match(i.BASE_PATH+'.*/([^/]+)/?$'),l=k&&k[1],m=i.overriddenVanities;if(!l||l.match('^'+m+'$')){return false;}else if(l.match('^\\.'+m+'$')){return l.substr(1);}else return l;}};e.exports=i;},null);
__d("ChatTypeaheadConstants",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();var g={USER_TYPE:'user',THREAD_TYPE:'thread',FRIEND_TYPE:'friend',NON_FRIEND_TYPE:'non_friend',FB4C_TYPE:'fb4c',PAGE_TYPE:'page',HEADER_TYPE:'header'};e.exports=g;},null);
__d("ChatOpenTab",["AsyncRequest","Event","requireWeak","ChatWelcomeMessage","ContextualThing","DOM","csx","cx","MercuryIDs","Parent","XAdsQEExposureController"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){b.__markCompiled&&b.__markCompiled();var r=null;i(['ChatApp'],function(ba){return r=ba;});var s=null;i(['ChatTabModel'],function(ba){return s=ba;});var t=716,u='messaging_tracking';function v(){d(['Toggler'],function(ba){var ca=ba.getInstance(l.scry(document,"div._1z4y")[0]);if(ca&&ca.getActive())ca.hide();});}function w(ba,ca){d(['LogHistory','MercuryThreads','WebMessengerPermalinkConstants','goURI'],function(da,ea,fa,ga){ea.get().getThreadMeta(ba,function(ha){if(r&&r.isInitialized()){r.tabController.openTab(ba,r.tabsViewport,ca);}else ga(fa.getURIPathForThreadID(ba));if(!aa.canOpenTab())da.getInstance('mercury').error('Unable to open chat tab',ha);});});if(document.documentElement.clientHeight<=t)v();}function x(ba,ca,da,ea,fa){h.listen(ba,'click',function(ga){if(aa.canOpenTab()){ea(ca,da);if(fa)return;return ga.kill();}});}function y(ba,ca,da,ea){var fa={referrer:ba||'',message_thread_id:ca,message_view:'chat',timestamp_send:Date.now()};if(da!==(void 0))fa.message_target_ids=[da];d(['ChatImpressionLogger'],function(ga){ga.logImpression(ba,da,ea);});d(['Banzai'],function(ga){ga.post(u,fa,{delay:0,retry:true});});}function z(ba){var ca=k.getContext(ba);return (ca&&p.byClass(ca,"_3qw")!==null);}var aa={canOpenTab:function(){return r&&!r.isHidden();},openEmptyTab:function(ba,ca,da){if(aa.canOpenTab()&&s){var ea=s.getEmptyTab();w(ea);y(ca,ea,null,da);v();return ea;}return null;},listenOpenEmptyTab:function(ba,ca){x(ba,null,ca,aa.openEmptyTab);},openThread:function(ba,ca,da,ea){d(['MercuryThreadIDMap'],function(fa){if(o.isValid(ba)){w(ba,ea);}else fa.get().getClientIDFromFBID(ba,function(ga){return w(ga,ea);});y(ca,ba,null,da);v();});},listenOpenThread:function(ba,ca,da){x(ba,ca,da,aa.openThread);},openUserTab:function(ba,ca,da){var ea=o.getThreadIDFromUserID(ba);w(ea);y(ca,ea,ba,da);return true;},openPageTab:function(ba,ca,da){d(['MercuryThreads'],function(ea){var fa=o.getThreadIDFromUserID(ca);ea.get().getThreadMeta(fa,function(ga){if(ba&&ba.length>0){var ha=(Date.now()-ga.timestamp)/1000,ia=ha/3600;if(ga.message_count===0||ia>24)j.setWelcomeMessage(fa,o.getParticipantIDFromUserID(ca),ba);}});w(fa);y(da,fa,ca);});return true;},listenOpenUserTab:function(ba,ca,da){if(!z(ba))x(ba,ca,da,aa.openUserTab);},listenOpenPageTab:function(ba,ca,da,ea,fa,ga){if(!z(ba))x(ba,ca,ea,function(ha,ia){if(fa)this.openPageTab(da,ha,ia);var ja=q.getURIBuilder().setString('name','page_message_open_chat').setString('id',ga);new g().setURI(ja.getURI()).setMethod('POST').send();}.bind(this),!fa);},openTabByType:function(ba,ca,da){d(['ChatTypeaheadConstants','MercuryParticipantTypes'],function(ea,fa){if(ca===ea.THREAD_TYPE){if(ba){aa.openThread(ba,da);}else aa.openEmptyTab(null,da);}else if(!ca||ca===fa.FRIEND||ca===ea.FRIEND_TYPE||ca===ea.PAGE_TYPE||ca===ea.USER_TYPE)aa.openUserTab(ba,da);});}};e.exports=aa;},null);
__d("getModuleLoader",["Bootloader","Promise"],function(a,b,c,d,e,f,g,h){b.__markCompiled&&b.__markCompiled();function i(k){"use strict";this.$ModuleLoader0=k;this.$ModuleLoader1=k.slice().sort().toString();}i.prototype.load=function(){"use strict";return new h(function(k){g.loadModules.call(g,this.$ModuleLoader0,function(){for(var l=[],m=0,n=arguments.length;m<n;m++)l.push(arguments[m]);k(l);});}.bind(this));};i.prototype.equals=function(k){"use strict";return this===k||this.$ModuleLoader1===k.$ModuleLoader1;};var j=function(k){return new i(k);};j.ModuleLoader=i;e.exports=j;},null);
__d("arrayStableSort",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();function g(h,i){return h.map(function(j,k){return {data:j,index:k};}).sort(function(j,k){return i(j.data,k.data)||(j.index-k.index);}).map(function(j){return j.data;});}e.exports=g;},null);
__d("RangedCallbackManager",["CallbackManagerController","arrayStableSort","createObjectFrom"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();function j(k,l,m){"use strict";this.$RangedCallbackManager0=[];this.$RangedCallbackManager1=false;this.$RangedCallbackManager2=false;this.$RangedCallbackManager3={};this.$RangedCallbackManager4=new g(this.$RangedCallbackManager5.bind(this));this.$RangedCallbackManager6=k;this.$RangedCallbackManager7=l;this.$RangedCallbackManager8=m;}j.prototype.executeOrEnqueue=function(k,l,m,n,o){"use strict";return this.$RangedCallbackManager4.executeOrEnqueue({start:k,limit:l},m,{strict:!!n,skipOnStrictHandler:o});};j.prototype.unsubscribe=function(k){"use strict";this.$RangedCallbackManager4.unsubscribe(k);};j.prototype.getUnavailableResources=function(k){"use strict";var l=this.$RangedCallbackManager4.getRequest(k),m=[];if(l&&!this.$RangedCallbackManager1){var n=l.request,o=this.$RangedCallbackManager9(l.options),p=n.start+n.limit;for(var q=o.length;q<p;q++)m.push(q);}return m;};j.prototype.addResources=function(k){"use strict";k.forEach(function(l){if(!this.$RangedCallbackManager3[l]){this.$RangedCallbackManager3[l]=true;this.$RangedCallbackManager0.push(l);this.$RangedCallbackManager2=null;}}.bind(this));this.resortResources();this.$RangedCallbackManager4.runPossibleCallbacks();};j.prototype.addResourcesWithoutSorting=function(k,l){"use strict";var m=this.$RangedCallbackManager0.slice(0,l);m=m.concat(k);m=m.concat(this.$RangedCallbackManager0.slice(l));this.$RangedCallbackManager0=m;Object.assign(this.$RangedCallbackManager3,i(k,true));this.$RangedCallbackManager2=null;this.$RangedCallbackManager4.runPossibleCallbacks();};j.prototype.removeResources=function(k){"use strict";k.forEach(function(l){if(this.$RangedCallbackManager3[l]){this.$RangedCallbackManager3[l]=false;var m=this.$RangedCallbackManager0.indexOf(l);if(m!=-1)this.$RangedCallbackManager0.splice(m,1);}}.bind(this));};j.prototype.removeAllResources=function(){"use strict";this.$RangedCallbackManager0=[];this.$RangedCallbackManager3={};};j.prototype.resortResources=function(){"use strict";this.$RangedCallbackManager0=h(this.$RangedCallbackManager0,function(k,l){return this.$RangedCallbackManager7(this.$RangedCallbackManager6(k),this.$RangedCallbackManager6(l));}.bind(this));};j.prototype.setReachedEndOfArray=function(){"use strict";if(!this.$RangedCallbackManager1){this.$RangedCallbackManager1=true;this.$RangedCallbackManager2=null;this.$RangedCallbackManager4.runPossibleCallbacks();}};j.prototype.hasReachedEndOfArray=function(){"use strict";return this.$RangedCallbackManager1;};j.prototype.setError=function(k){"use strict";if(this.$RangedCallbackManager2!==k){this.$RangedCallbackManager2=k;this.$RangedCallbackManager4.runPossibleCallbacks();}};j.prototype.getError=function(k,l,m){"use strict";var n=this.$RangedCallbackManager9({strict:m});return k+l>n.length?this.$RangedCallbackManager2:null;};j.prototype.hasResource=function(k){"use strict";return this.$RangedCallbackManager3[k];};j.prototype.getResourceAtIndex=function(k){"use strict";return this.$RangedCallbackManager0[k];};j.prototype.getAllResources=function(){"use strict";return this.$RangedCallbackManager0.concat();};j.prototype.getCurrentArraySize=function(k){"use strict";return this.$RangedCallbackManager9(k).length;};j.prototype.$RangedCallbackManager9=function(k){"use strict";var l=this.$RangedCallbackManager0;if(k&&k.strict){var m=k.skipOnStrictHandler||this.$RangedCallbackManager8;if(m)l=l.filter(m);}return l;};j.prototype.$RangedCallbackManager5=function(k,l){"use strict";var m=this.$RangedCallbackManager9(l);if(!this.$RangedCallbackManager1&&!this.$RangedCallbackManager2&&k.start+k.limit>m.length){return false;}else{var n=m.slice(k.start,k.start+k.limit),o=k.start+k.limit>m.length?this.$RangedCallbackManager2:null;return [n,o];}};j.prototype.getElementsUntil=function(k){"use strict";var l=[];for(var m=0;m<this.$RangedCallbackManager0.length;m++){var n=this.$RangedCallbackManager6(this.$RangedCallbackManager0[m]);if(this.$RangedCallbackManager7(n,k)>0)break;l.push(this.$RangedCallbackManager0[m]);}return l;};e.exports=j;},null);
__d("MercuryFolders",["MercuryConfig","MessagingTag","arrayContains"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();var j=[h.INBOX,h.OTHER,h.ACTION_ARCHIVED,h.SPAM],k=[h.INBOX,h.PENDING,h.OTHER,h.ACTION_ARCHIVED],l={getSupportedFolders:function(){return g.CoreGraphEnabled?k.concat():j.concat();},isSupportedFolder:function(m){return i(j,m);},getFromMeta:function(m){var n=m.folder;if(m.is_archived)n=h.ACTION_ARCHIVED;return n;}};e.exports=l;},null);
__d("MercuryUnreadState",["MercuryFolders","LogHistory","KeyedCallbackManager","MercuryActionType","MercuryDispatcher","MercuryGlobalActionType","MercurySingletonMixin","MercuryThreadlistConstants","MercuryThreadIDMap","MessagingTag","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","arrayContains","copyProperties","createObjectFrom"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){b.__markCompiled&&b.__markCompiled();var w=(g.getSupportedFolders()||[]).filter(function(oa){return oa!=p.ACTION_ARCHIVED;}),x='unread_thread_hash',y='unseen_thread_list',z=n.MAX_UNREAD_COUNT,aa=h.getInstance('mercury_unread_state');function ba(oa){this._fbid=oa;this._serverRequests=q.getForFBID(this._fbid);this._threadIDMap=o.getForFBID(this._fbid);this._threadInformer=r.getForFBID(this._fbid);this._threads=s.getForFBID(this._fbid);this._dispatcher=k.getForFBID(this._fbid);this._allReadTimestamp={};this._threadReadTimestamp={};this._initialUnreadCount={};this._maxCount={};this._unreadResources={};w.forEach(function(pa){this._initialUnreadCount[pa]=0;this._maxCount[pa]=false;this._unreadResources[pa]=new i();}.bind(this));this._dispatcher.subscribe('update-unread',function(pa,qa){ga(this,qa);var ra=qa.global_actions||[];for(var sa=0;sa<ra.length;sa++){var ta=ra[sa];if(ta.action_type==l.MARK_ALL_READ)ja(this,ta.folder,ta.timestamp);}}.bind(this));this._dispatcher.subscribe('update-thread-ids',function(pa,qa){la(this,qa);}.bind(this));}Object.assign(ba.prototype,{getUnreadCount:function(oa){if(this.exceedsMaxCount(oa)){aa.error('unguarded_unread_count_fetch',{});return 0;}return fa(this,oa);},exceedsMaxCount:function(oa){return this._maxCount[oa]||(fa(this,oa)>z);},markFolderAsRead:function(oa){if(this._maxCount[oa]||fa(this,oa)>0)this._serverRequests.markFolderAsRead(oa);},getIsThreadUnread:function(oa,pa){var qa=pa||p.INBOX,ra=ea(this,qa);return ra&&ra[oa];}});u(ba,m);function ca(oa,pa,qa){oa._unreadResources[pa].setResource(x,qa);oa._unreadResources[pa].setResource(y,Object.keys(qa));}function da(oa,pa,qa){var ra=oa._unreadResources[pa].executeOrEnqueue(x,qa),sa=oa._unreadResources[pa].getUnavailableResources(ra);if(sa.length)oa._serverRequests.fetchUnreadThreadIDs(pa);}function ea(oa,pa){return oa._unreadResources[pa].getResource(x);}function fa(oa,pa){var qa=oa._unreadResources[pa].getResource(y);if(qa){return qa.length;}else return oa._initialUnreadCount[pa];}function ga(oa,pa){var qa;(pa.unread_thread_fbids||[]).forEach(function(ra){qa=ra.folder;if(!na(qa))return;var sa=ra.thread_fbids||[];sa=sa.concat(ra.other_user_fbids||[]);var ta=ka(oa,sa);ca(oa,qa,v(ta,true));if(ta.length>z)oa._maxCount[qa]=true;oa._threadInformer.updatedUnreadState();});(pa.message_counts||[]).forEach(function(ra){if(ra.unread_count===(void 0))return;qa=ra.folder;if(ra.unread_count>z){oa._maxCount[qa]=true;ca(oa,qa,{});oa._threadInformer.updatedUnreadState();}else{oa._initialUnreadCount[qa]=ra.unread_count;if(oa._initialUnreadCount[qa]===0)ca(oa,qa,{});oa._threadInformer.updatedUnreadState();}});(pa.actions||[]).forEach(function(ra){if(ra.is_forward)return;var sa=j,ta=ra.other_user_fbid?ra.other_user_fbid:ra.thread_fbid,ua=ra.thread_id?ra.thread_id:ta;if(ra.action_type==sa.DELETE_THREAD){w.forEach(function(wa){ia(oa,wa,ua);});}else if(ra.action_type==sa.CHANGE_ARCHIVED_STATUS||ra.action_type==sa.CHANGE_FOLDER){var va=oa._threads.getThreadMetaNow(ra.thread_id);qa=g.getFromMeta(va);if(na(qa)&&va.unread_count>0)ha(oa,qa,ua);w.forEach(function(wa){if(wa!=qa)ia(oa,wa,ua);});}else{qa=ma(oa,ra);if(!na(qa))return;if(ra.action_type==sa.CHANGE_READ_STATUS){if(ra.mark_as_read){ia(oa,qa,ua,ra.timestamp);}else ha(oa,qa,ua,ra.timestamp);}else if(ra.action_type==sa.USER_GENERATED_MESSAGE||ra.action_type==sa.LOG_MESSAGE)if(ra.is_unread)ha(oa,qa,ua,ra.timestamp);}});}function ha(oa,pa,qa,ra){if(oa._maxCount[pa])return;da(oa,pa,function(sa){var ta=oa._allReadTimestamp[pa]||0,ua=oa._threadReadTimestamp[qa]||0,va=ra||Number.POSITIVE_INFINITY;if(va>=ta&&va>=ua&&!sa[qa]){sa[qa]=ra||0;ca(oa,pa,sa);oa._threadInformer.updatedUnreadState();}});}function ia(oa,pa,qa,ra){if(oa._maxCount[pa])return;da(oa,pa,function(sa){if(ra){var ta=oa._threadReadTimestamp[qa];if(!ta||ta<ra)oa._threadReadTimestamp[qa]=ra;}var ua=sa[qa];if(ra&&typeof ua=='number'&&ra<ua)return;if(qa in sa){delete sa[qa];ca(oa,pa,sa);oa._threadInformer.updatedUnreadState();}});}function ja(oa,pa,qa){oa._maxCount[pa]=false;ca(oa,pa,{});oa._allReadTimestamp[pa]=Math.max(oa._allReadTimestamp[pa]||0,qa||0);oa._threadInformer.updatedUnreadState();}function ka(oa,pa){return pa.map(oa._threadIDMap.convertThreadIDIfAvailable,oa._threadIDMap);}function la(oa,pa){w.forEach(function(qa){var ra=ea(oa,qa);if(!ra)return;for(var sa in pa){var ta=pa[sa];if(ra[sa]){ra[ta]=ra[sa];delete ra[sa];}}ca(oa,qa,ra);});}function ma(oa,pa){var qa=pa.thread_id?oa._threads.getThreadMetaNow(pa.thread_id):null;return qa?g.getFromMeta(qa):pa.folder;}function na(oa){return t(w,oa);}e.exports=ba;},null);
__d("MessagingReliabilityLogger",["PresenceUtil","MercuryServerDispatcher","MessagingReliabilityLoggerInitialData","isEmpty","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k){b.__markCompiled&&b.__markCompiled();var l='/ajax/mercury/client_reliability.php',m=60000;function n(t,u){var v={app:i.app,categories:JSON.stringify(t)};if(!j(u))v.extra=JSON.stringify(u);return v;}function o(t,u,v,w){if(t[u]===(void 0))t[u]={};if(t[u][v]===(void 0))t[u][v]=0;t[u][v]+=w;}function p(t,u,v,w){if(t[u]===(void 0))t[u]={};if(t[u][v]===(void 0))t[u][v]=[];for(var x=0;x<w.length;++x)t[u][v].push(w[x]);}function q(t,u){if((t&&!t.categories)||(u&&!u.categories))return;var v=t?JSON.parse(t.categories):{},w=t&&t.extra?JSON.parse(t.extra):{},x=JSON.parse(u.categories),y=u.extra?JSON.parse(u.extra):{};for(var z in x){var aa=x[z],ba=y[z];for(var ca in aa){o(v,z,ca,aa[ca]);if(ba!==(void 0)){var da=ba[ca];if(da!==(void 0))p(w,z,ca,da);}}}return n(v,w);}var r={};r[l]={mode:h.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:q};h.registerEndpoints(r);var s={addEntry:function(t,u,v){if(!i.enabled)return;var w={};o(w,t,u,1);var x={};if(v!==(void 0))p(x,t,u,[v]);h.trySend(l,n(w,x));}};(function t(){s.addEntry('page_event','active',g.getSessionID());k(t,m);})();e.exports=s;},null);